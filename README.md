# 面部考勤系统 (Face Attendance System)

基于 face-api.js 开发的智能面部考勤系统，支持实时面部识别和考勤统计。

## 🚀 快速开始

### 1. 启动后端服务器
```bash
cd attendance-system/backend
npm install
npm start
```

### 2. 访问系统
打开浏览器访问：`http://localhost:3001`

## 🎯 最新功能更新

### ✅ 新增功能
- **智能会话管理**：基于班级和课程自动生成会话ID，包含时间戳
- **重复会话检测**：在40分钟内检测相同班级-课程的重复会话，防止重复考勤
- **智能覆盖提示**：发现重复会话时提示用户是否覆盖原有记录
- **下钻式报告**：点击学生姓名查看详细考勤记录
- **头像比对显示**：实时显示检测到的面部与注册头像的比对
- **状态指示器**：实时显示考勤系统运行状态和检测进度
- **调试工具**：内置调试页面帮助诊断问题

### ✅ 改进功能
- **会话ID格式**：`班级-课程(开始时间 - 结束时间)`
- **报告页面**：下拉选择器显示所有历史会话
- **用户体验**：更好的加载提示和错误处理
- **出勤率计算优化**：修复统计中的出勤率计算，分母现在正确使用相同班级-课程的考勤会话次数
- **重复会话防护**：40分钟内防止相同班级-课程的重复考勤会话

## 📋 系统功能

- ✅ **学生注册**：支持摄像头拍照和图片上传
- ✅ **智能实时考勤**：摄像头实时面部识别，支持会话管理，相似度≥70%，持续检测≥1秒
- ✅ **批量处理**：上传多张照片批量考勤
- ✅ **统计分析**：总体统计、按课程统计、按班级统计
- ✅ **考勤报告**：详细的考勤记录和统计表格，支持下钻查看
- ✅ **国际化支持**：中英文双语界面
- ✅ **响应式设计**：适配不同设备屏幕
- ✅ **调试工具**：内置诊断页面和实时日志

## 🔧 故障排除

### CDN 模型加载问题

如果遇到"Couldn't find the requested file"错误，请尝试以下解决方案：

#### 方案1：等待重试
系统会自动尝试备用CDN，如果失败会显示错误信息。

#### 方案2：使用本地模型文件
如果CDN持续不可用，可以下载模型文件到本地：

1. 下载模型文件：
   ```bash
   # 创建weights目录
   mkdir attendance-system/frontend/weights

   # 下载模型文件（需要科学上网）
   cd attendance-system/frontend/weights
   curl -O https://unpkg.com/face-api.js@0.22.2/weights/tiny_face_detector_model-weights_manifest.json
   curl -O https://unpkg.com/face-api.js@0.22.2/weights/tiny_face_detector_model-shard1
   curl -O https://unpkg.com/face-api.js@0.22.2/weights/face_landmark_68_model-weights_manifest.json
   curl -O https://unpkg.com/face-api.js@0.22.2/weights/face_landmark_68_model-shard1
   curl -O https://unpkg.com/face-api.js@0.22.2/weights/face_recognition_model-weights_manifest.json
   curl -O https://unpkg.com/face-api.js@0.22.2/weights/face_recognition_model-shard1
   curl -O https://unpkg.com/face-api.js@0.22.2/weights/face_recognition_model-shard2
   ```

2. 修改 `app.js` 中的模型URL：
   ```javascript
   const MODEL_URL = './weights/'; // 改为本地路径
   ```

#### 方案3：使用备用CDN
在 `index.html` 中切换到备用CDN：
```html
<!-- 取消注释备用CDN -->
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
```

## 🏗️ 系统架构

```
attendance-system/
├── backend/                 # Node.js后端
│   ├── server.js           # Express服务器
│   ├── database.js         # SQLite数据库配置
│   └── routes/             # API路由
│       ├── faces.js        # 面部数据管理
│       └── attendance.js   # 考勤记录管理
└── frontend/               # 前端界面
    ├── index.html          # 主页面
    ├── css/
    │   └── styles.css      # 样式文件
    └── js/
        ├── app.js          # 前端逻辑
        └── i18n.js         # 国际化支持
```

## 📊 API 接口

### 面部管理
- `GET /api/faces` - 获取所有注册面部
- `POST /api/faces` - 注册新面部
- `PUT /api/faces/:id` - 更新面部信息
- `DELETE /api/faces/:id` - 删除面部

### 考勤管理
- `GET /api/attendance` - 获取考勤记录
- `POST /api/attendance` - 记录考勤
- `GET /api/attendance/summary/:session_id` - 获取会话统计

### 统计分析
- `GET /api/attendance/stats/overall` - 总体统计
- `GET /api/attendance/stats/by-course` - 按课程统计
- `GET /api/attendance/stats/by-class` - 按班级统计

## 🔐 技术栈

- **前端**：HTML5, CSS3, JavaScript (ES6+)
- **后端**：Node.js, Express.js
- **数据库**：SQLite3
- **AI引擎**：face-api.js (TensorFlow.js)
- **国际化**：自定义i18n系统 (中英文)
- **样式**：原生CSS (响应式设计)

## 🧠 智能考勤算法

### 核心特性
- **高精度识别**：面部相似度阈值设为70%，比传统60%更严格
- **持续检测**：要求同一面部持续出现1秒以上，避免误识别
- **防重复记录**：每个学生在同一会话中只记录一次
- **实时跟踪**：每300毫秒检测一次，响应迅速

### 算法流程
1. **面部检测**：使用TinyFaceDetector检测视频流中的面部
2. **特征提取**：计算面部特征向量（128维）
3. **相似度匹配**：与已注册面部进行余弦相似度计算
4. **阈值过滤**：相似度≥70%的面部进入持续检测阶段
5. **时间跟踪**：记录面部首次出现时间和持续时间
6. **考勤记录**：持续出现≥1秒时记录考勤并从跟踪列表移除

### 优势
- **减少误识别**：双重验证（相似度 + 持续时间）
- **提高准确率**：避免瞬间误识别和背景干扰
- **用户友好**：清晰的识别状态反馈
- **性能优化**：智能清理过期跟踪数据

## 🔧 调试和故障排除

### 调试页面
如果遇到问题，可以使用调试页面进行诊断：
```
http://localhost:3001/debug.html
```

调试页面可以检查：
- ✅ 系统状态（face-api.js加载、服务器连接、摄像头权限）
- ✅ 模型加载状态
- ✅ 数据库连接
- ✅ 摄像头访问
- ✅ 实时调试日志
- ✅ 快速测试功能（一键检查所有组件）

### 快速诊断
1. **打开调试页面**：`http://localhost:3001/debug.html`
2. **运行快速测试**：点击"运行快速测试"按钮
3. **查看结果**：系统会自动检查所有关键组件
4. **查看日志**：打开浏览器控制台查看详细日志

### 实时监控
- **考勤检测日志**：显示面部检测和匹配过程
- **相似度监控**：实时显示面部匹配相似度数值
- **持续时间跟踪**：显示面部持续出现的时间
- **状态指示器**：显示系统运行状态和检测进度

### 常见问题

#### 问题：考勤系统没有自动抓取
**解决方案：**
1. 打开调试页面检查系统状态
2. 确保已注册至少一个学生面部
3. 检查浏览器控制台的调试日志
4. 确认摄像头权限已授予

#### 问题：模型加载失败
**解决方案：**
1. 检查网络连接
2. 尝试刷新页面
3. 使用备用CDN（在index.html中取消注释）

#### 问题：摄像头访问失败
**解决方案：**
1. 确保浏览器支持WebRTC
2. 检查摄像头权限设置
3. 尝试在HTTPS环境下使用
4. 查看页面顶部的摄像头状态指示器
5. 如果显示"被拒绝"，请在浏览器地址栏点击摄像头图标重新授权

#### 问题：摄像头状态显示"被拒绝"
**解决方案：**
1. 点击浏览器地址栏左侧的摄像头图标
2. 选择"始终允许"或"允许"
3. 刷新页面重新检查权限
4. 如果问题持续，尝试在隐身模式下打开

#### 问题：提示发现重复考勤会话
**解决方案：**
1. 系统在40分钟内检测到相同班级-课程的重复会话
2. 点击"确定"覆盖上一次记录，原有考勤数据将被清除
3. 点击"取消"取消当前操作，建议等待40分钟后再试
4. 这是为了防止同一节课被重复考勤

#### 问题：出勤率计算不正确
**解决方案：**
1. 确保数据库中有关联的会话记录
2. 出勤率分母现在使用相同班级-课程的实际会话次数
3. 如果仍有问题，请检查数据库中的会话和考勤记录

## 📝 使用说明

### 1. 注册学生
- 输入班级、姓名、课程信息
- 点击"Start Webcam Registration"启动摄像头，或上传照片
- 系统会自动提取面部特征并保存到数据库

### 2. 开始考勤会话
- **摄像头状态检查**：页面会自动检查摄像头权限状态
- 从班级下拉菜单选择班级
- 从课程下拉菜单选择课程
- 点击"Start Attendance Session"开始考勤
- **智能会话ID**：系统自动生成格式为 `班级-课程(开始时间)`
- **智能识别算法**：系统会实时检测面部，只有当：
  - 面部相似度 ≥ 70%（与注册面部匹配）
  - 同一面部持续出现 ≥ 1秒
  - 才会记录考勤
- 每个学生在同一会话中只会被记录一次
- **重复会话检测**：如果在40分钟内尝试开启相同班级-课程的会话，系统会提示是否覆盖上一次记录
- 点击"Stop Attendance"停止当前会话，系统会更新会话ID为完整时间范围

### 摄像头权限说明
- **📷✅ 已授权**：摄像头权限正常，可以正常使用
- **📷❌ 被拒绝**：需要允许摄像头权限才能使用考勤功能
- **📷❓ 等待授权**：系统将请求摄像头权限，请点击"允许"
- **📷🔄 检查中**：系统正在检查摄像头状态

### 3. 查看统计分析
- 点击"Statistics"页面查看总体统计
- 点击"Load Course Statistics"查看按课程统计
- 点击"Load Class Statistics"查看按班级统计
- 彩色编码显示出勤率（🟢 ≥80%, 🟡 60-79%, 🔴 <60%）

### 4. 查看考勤报告
- 从下拉菜单选择历史会话（显示完整时间范围）
- 点击"Load Report"
- 查看该会话的详细考勤记录表格
- **下钻查看**：点击学生姓名查看该学生的详细考勤时间记录
- 支持查看每个学生的具体考勤时间戳

### 5. 批量处理
- 上传多张包含学生的照片
- 系统会自动识别并记录考勤
- 适合处理线下拍摄的照片

### 6. 语言切换
- 点击右上角的语言按钮
- 支持中文 ↔ English 切换
- 设置会自动保存

## ⚠️ 注意事项

- 首次使用需要下载AI模型，可能需要一些时间
- 确保浏览器支持WebRTC（摄像头访问）
- 建议在HTTPS环境下使用（生产环境）
- 面部识别准确度受光线、角度等因素影响
- **智能考勤算法**：面部相似度≥70%，持续出现≥1秒才记录
- 每个学生在同一考勤会话中只会被记录一次
- **智能会话管理**：会话ID自动生成，包含班级、课程和时间戳
- **重复会话防护**：40分钟内防止相同班级-课程的重复考勤会话
- **智能覆盖提示**：发现重复会话时提示用户是否覆盖原有记录
- **下钻式报告**：点击学生姓名查看详细考勤记录
- **实时状态监控**：系统运行状态和检测进度实时显示
- 统计数据实时更新，支持多维度分析
- **出勤率计算优化**：分母使用相同班级-课程的实际会话次数
- 支持中英文界面切换，设置会自动保存
- **调试工具**：内置诊断页面帮助快速定位问题

## 🤝 贡献

欢迎提交Issue和Pull Request来改进系统！

## 📄 许可证

MIT License